<!DOCTYPE html>
<html lang="zh-TW">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
    <meta property="og:type" content="website">
    <meta property="og:url" content="{{ request.url }}">
    <meta property="og:title" content="{% block og_title %}{{ site_name }}{% endblock %}">
    <meta property="og:description" content="{% block og_description %}{{ site_description }}{% endblock %}">
    <meta property="og:image" content="{{ url_for('static', filename='preview-image.png', _external=True) }}">
    <meta name="twitter:card" content="summary_large_image">
    <meta name="twitter:url" content="{{ request.url }}">
    <meta name="twitter:title" content="{% block twitter_title %}{{ site_name }}{% endblock %}">
    <meta name="twitter:description" content="{% block twitter_description %}{{ site_description }}{% endblock %}">
    <meta name="twitter:image" content="{{ url_for('static', filename='preview-image.png', _external=True) }}">
    <title>Space Reservation - {{ session.get('username', 'шикхов') }}</title>
    <link href="{{ url_for('static', filename='style.css') }}" rel="stylesheet">
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.1/font/bootstrap-icons.css">
    <link href='https://cdn.jsdelivr.net/npm/fullcalendar@6.1.8/index.global.min.css' rel='stylesheet' />
    <link rel="icon" type="image/png" href="{{ url_for('static', filename='favicon.ico') }}">
    <link rel="apple-touch-icon" href="{{ url_for('static', filename='favicon.ico') }}">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/flatpickr/dist/flatpickr.min.css">
    <script src="https://cdn.jsdelivr.net/npm/flatpickr"></script>
    <script src="https://npmcdn.com/flatpickr/dist/l10n/zh-tw.js"></script>
</head>

<body>
    <header class="main-nav">
        <div class="nav-wrapper">
            <a class="nav-logo" href="{{ url_for('home') }}">
                <i class="bi bi-terminal-fill"></i>
                <span id="site-name">{{ site_name }}</span>
            </a>
            <nav class="nav-menu">
                <a href="{{ url_for('home') }}">All Spaces</a>

                {% if session.get('user_id') %}
                {% if session.get('user_perm_mask', 0)|has_perm(2) %}
                <a href="{{ url_for('my_bookings') }}">My Bookings</a>
                {% endif %}

                {% if session.get('user_perm_mask', 0)|has_perm(1) %}
                <div class="dropdown">
                    <button class="dropbtn text-pink">Admin Console <i class="bi bi-chevron-down"></i></button>
                    <div class="dropdown-content">
                        <a href="{{ url_for('admin_dashboard') }}">Booking Review</a>
                        <a href="{{ url_for('manage_assets') }}">Asset Management</a>
                        <a href="{{ url_for('add_user') }}">Add User</a>
                        <div class="divider"></div>
                    </div>
                </div>
                {% endif %}
                {% endif %}
            </nav>

            <div class="nav-auth">
                {% if session.get('user_id') %}
                <span class="user-badge"><i class="bi bi-person-fill"></i> {{ session.get('username') }}</span>
                <a href="{{ url_for('logout') }}" class="btn-outline-pink">Logout</a>
                {% else %}
                <a href="{{ url_for('login') }}" class="btn-pink">Login</a>
                {% endif %}
            </div>
        </div>
    </header>

    <main class="content-wrapper">
        <div class="flash-container">
            {% with messages = get_flashed_messages(with_categories=true) %}
            {% if messages %}
            {% for category, message in messages %}
            <div class="alert alert-{{ category }}">{{ message }}</div>
            {% endfor %}
            {% endif %}
            {% endwith %}
        </div>

        <section class="page-body">
            {% block content %}{% endblock %}
        </section>

        {% block calendar_section %}
        {% include 'includes/_calendar.html' %}
        {% endblock %}

        {% include 'includes/_debug.html' %}
    </main>

    <footer class="main-footer">
    </footer>

    <script>
        flatpickr('input[type="datetime-local"]', {
            enableTime: true,
            dateFormat: "Y-m-d H:00",
            minDate: "today",            
            time_24hr: true,
            minuteIncrement: 60,
            disableMobile: "true"
        });
        if (/mobi|android|iPhone/i.test(navigator.userAgent)) {
            const span = document.getElementById('site-name');
            if (span) span.style.display = 'none';
        }

        document.addEventListener('DOMContentLoaded', function () {
            const bookingForm = document.querySelector('.booking-form');
            const startInput = document.querySelector('input[name="start_time"]');
            const endInput = document.querySelector('input[name="end_time"]');

            if (startInput) {
                const updateMinLimit = () => {
                    const now = new Date();
                    now.setMinutes(now.getMinutes() - now.getTimezoneOffset());
                    const minString = now.toISOString().slice(0, 16);
                    startInput.min = minString;
                };

                updateMinLimit();
                startInput.addEventListener('change', function () {
                    if (endInput) {
                        endInput.min = this.value;
                    }
                });
            }
            if (bookingForm) {
                bookingForm.addEventListener('submit', function (e) {
                    const startTime = new Date(startInput.value);
                    const endTime = endInput ? new Date(endInput.value) : null;
                    const now = new Date();

                    if (startTime < now) {
                        e.preventDefault();
                        alert('Reservation start time cannot be earlier than the current time!');
                        return;
                    }

                    if (endTime && endTime <= startTime) {
                        e.preventDefault();
                        alert('End time must be later than start time!');
                        return;
                    }
                });
            }
        });
    </script>
</body>

</html>